<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Curso en Línea</title>
    <!-- Link to the Tailwind CSS library for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to Font Awesome for course icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        @keyframes fade-in-down {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .animate-fade-in-down {
            animation: fade-in-down 0.5s ease-out;
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out;
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out;
        }
        /* Payment modal styles */
        .payment-modal, .alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .certificate-container {
            background-image: url('https://placehold.co/1000x700/D4F5E6/0C2719?text=Certificado');
            background-size: cover;
            background-position: center;
        }
        .diploma-container {
            background-image: url('https://placehold.co/1000x700/EFEFEF/333333?text=Diploma');
            background-size: cover;
            background-position: center;
        }
        /* Chatbot styles */
        .chatbot-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 900;
            width: 320px;
            height: 400px;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transform: scale(0);
            transition: transform 0.3s ease-out;
            transform-origin: bottom right;
        }
        .chatbot-container.active {
            transform: scale(1);
        }
        .chatbot-header {
            background-color: #3b82f6;
            color: white;
            padding: 1rem;
            border-radius: 1rem 1rem 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-body {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #f3f4f6;
        }
        .chatbot-input {
            padding: 1rem;
            background-color: #e5e7eb;
            border-radius: 0 0 1rem 1rem;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background-color: #d1d5db;
            color: black;
            align-self: flex-start;
            margin-right: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header of the page -->
    <header class="bg-blue-800 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold">Mi Curso en Línea</h1>
            <nav class="space-x-6 flex items-center">
                <a href="#" onclick="cargarPagina('inicio')" class="hover:text-blue-200 transition-colors duration-200">Inicio</a>
                
                <a href="#" onclick="cargarCursosPorTipo('todos')" class="hover:text-blue-200 transition-colors duration-200">
                    Cursos
                </a>

                <a href="#" onclick="checkAndLoadVirtualClassroom()" class="hover:text-blue-200 transition-colors duration-200">Aula Virtual</a>
                <a href="#" onclick="checkAuthState()" class="hover:text-blue-200 transition-colors duration-200">Certificados</a>
                <a href="#" onclick="cargarPagina('contacto')" class="hover:text-blue-200 transition-colors duration-200">Contacto</a>
            </nav>
        </div>
    </header>

    <main id="contenido" class="flex-grow container mx-auto p-8">
        <!-- Page content will be loaded here dynamically -->
    </main>

    <!-- Payment modal (hidden by default) -->
    <div id="payment-modal" class="payment-modal hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-11/12 md:w-1/2 lg:w-1/3 animate-fade-in">
            <h3 id="payment-course-title" class="text-2xl font-bold text-gray-800 mb-4">Pago de curso</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-1">Número de tarjeta</label>
                    <input type="text" id="card-number" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="XXXX XXXX XXXX XXXX">
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label class="block text-gray-700 font-medium mb-1">Fecha de expiración</label>
                        <input type="text" id="card-expiry" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="MM/AA">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-gray-700 font-medium mb-1">CVC</label>
                        <input type="text" id="card-cvc" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="XXX">
                    </div>
                </div>
                <button id="confirm-payment-button" onclick="simularProcesoDePago()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-full hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105">
                    Confirmar pago
                </button>
            </div>
            <button onclick="cerrarPago()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
    </div>
    
    <!-- Custom modal for alerts -->
    <div id="alert-modal" class="alert-modal hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-11/12 md:w-1/2 lg:w-1/3 animate-fade-in">
            <h3 id="alert-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="alert-message" class="text-gray-700 mb-6"></p>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-full hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105">Cerrar</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 p-4 text-center mt-8">
        <p>&copy; 2025 Mi Curso en Línea - Todos los derechos reservados.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userAuthState = { user: null, loaded: false };
        let tempCourseData = null; // Temporary variable to hold course registration data

        // Set log level to see Firebase logs in the console
        setLogLevel('debug');

        // Course data structure (now stored in a local variable, could be in Firestore public collection)
        const cursosData = [
            { id: 'java', title: 'Java Avanzado', icon: 'fab fa-java', description: 'Profundiza en programación Java, POO, hilos y proyectos completos.', duration: '8 semanas', modality: 'Virtual', color: 'bg-blue-600', ringColor: 'focus:ring-blue-500', buttonColor: 'text-blue-600', type: 'programacion' },
            { id: 'python', title: 'Python Avanzado', icon: 'fab fa-python', description: 'Aprende Python avanzado, ciencia de datos y automatización de procesos.', duration: '8 semanas', modality: 'Virtual', color: 'bg-green-600', ringColor: 'focus:ring-green-500', buttonColor: 'text-green-600', type: 'programacion' },
            { id: 'machine-learning', title: 'Machine Learning', icon: 'fas fa-brain', description: 'Fundamentos, algoritmos y proyectos prácticos de inteligencia artificial.', duration: '10 semanas', modality: 'Virtual', color: 'bg-purple-600', ringColor: 'focus:ring-purple-500', buttonColor: 'text-purple-600', type: 'programacion' },
            { id: 'nanorecubrimientos', title: 'Nanorrecubrimientos Avanzados', icon: 'fas fa-microscope', description: 'Explora la ciencia y aplicación de recubrimientos a nivel nanométrico.', duration: '12 semanas', modality: 'Virtual', color: 'bg-red-600', ringColor: 'focus:ring-red-500', buttonColor: 'text-red-600', type: 'recubrimientos' },
            { id: 'automotrices', title: 'Recubrimientos Automotrices', icon: 'fas fa-car', description: 'Técnicas de pintura y protección para la industria automotriz.', duration: '9 semanas', modality: 'Virtual', color: 'bg-indigo-600', ringColor: 'focus:ring-indigo-500', buttonColor: 'text-indigo-600', type: 'recubrimientos' },
            { id: 'industriales', title: 'Pinturas y Barnices Industriales', icon: 'fas fa-industry', description: 'Aprende sobre la formulación y uso de recubrimientos para entornos industriales.', duration: '10 semanas', modality: 'Virtual', color: 'bg-gray-800', ringColor: 'focus:ring-gray-600', buttonColor: 'text-gray-800', type: 'recubrimientos' },
            { id: 'anticorrosivos', title: 'Recubrimientos Anticorrosivos', icon: 'fas fa-shield-alt', description: 'Estrategias y materiales para la prevención de la corrosión.', duration: '8 semanas', modality: 'Virtual', color: 'bg-yellow-600', ringColor: 'focus:ring-yellow-500', buttonColor: 'text-yellow-600', type: 'recubrimientos' },
            { id: 'esmaltes', title: 'Esmaltes Cerámicos y Vidriados', icon: 'fas fa-palette', description: 'Proceso de creación y aplicación de esmaltes y vidriados.', duration: '7 semanas', modality: 'Virtual', color: 'bg-pink-600', ringColor: 'focus:ring-pink-500', buttonColor: 'text-pink-600', type: 'recubrimientos' },
            { id: 'polvo', title: 'Recubrimientos de Polvo', icon: 'fas fa-spray-can', description: 'Fundamentos y técnicas de aplicación de la pintura en polvo.', duration: '6 semanas', modality: 'Virtual', color: 'bg-teal-600', ringColor: 'focus:ring-teal-500', buttonColor: 'text-teal-600', type: 'recubrimientos' },
            { id: 'sostenibles', title: 'Recubrimientos Sostenibles', icon: 'fas fa-leaf', description: 'Innovaciones en recubrimientos ecológicos y de bajo impacto ambiental.', duration: '11 semanas', modality: 'Virtual', color: 'bg-lime-600', ringColor: 'focus:ring-lime-500', buttonColor: 'text-lime-600', type: 'recubrimientos' },
            { id: 'pulido', title: 'Técnicas de Pulido y Acabado', icon: 'fas fa-star', description: 'Mejora tus habilidades en pulido y obtención de acabados de alta calidad.', duration: '5 semanas', modality: 'Virtual', color: 'bg-cyan-600', ringColor: 'focus:ring-cyan-500', buttonColor: 'text-cyan-600', type: 'recubrimientos' },
            { id: 'madera', title: 'Recubrimientos para Madera', icon: 'fas fa-tree', description: 'Tipos y aplicaciones de barnices y selladores para madera.', duration: '6 semanas', modality: 'Virtual', color: 'bg-amber-600', ringColor: 'focus:ring-amber-500', buttonColor: 'text-amber-600', type: 'recubrimientos' },
            { id: 'construccion', title: 'Recubrimientos para Construcción', icon: 'fas fa-hard-hat', description: 'Soluciones de recubrimiento para fachadas, pisos y estructuras.', duration: '9 semanas', modality: 'Virtual', color: 'bg-emerald-600', ringColor: 'focus:ring-emerald-500', buttonColor: 'text-emerald-600', type: 'recubrimientos' },
            { id: 'marinos', title: 'Recubrimientos Marinos', icon: 'fas fa-ship', description: 'Sistemas de recubrimiento para embarcaciones y estructuras oceánicas.', duration: '10 semanas', modality: 'Virtual', color: 'bg-sky-600', ringColor: 'focus:ring-sky-500', buttonColor: 'text-sky-600', type: 'recubrimientos' },
            { id: 'alimentarios', title: 'Recubrimientos Alimentarios', icon: 'fas fa-utensils', description: 'Regulaciones y técnicas de aplicación en la industria alimentaria.', duration: '7 semanas', modality: 'Virtual', color: 'bg-orange-600', ringColor: 'focus:ring-orange-500', buttonColor: 'text-orange-600', type: 'recubrimientos' },
            { id: 'sanitario', title: 'Recubrimientos para el Sector Sanitario', icon: 'fas fa-hospital', description: 'Materiales y técnicas para superficies higiénicas en hospitales y clínicas.', duration: '8 semanas', modality: 'Virtual', color: 'bg-gray-600', ringColor: 'focus:ring-gray-500', buttonColor: 'text-gray-600', type: 'recubrimientos' },
            { id: 'aeroespacial', title: 'Recubrimientos para la Industria Aeroespacial', icon: 'fas fa-rocket', description: 'Materiales de alta tecnología para aeronaves y naves espaciales.', duration: '15 semanas', modality: 'Virtual', color: 'bg-blue-900', ringColor: 'focus:ring-blue-800', buttonColor: 'text-blue-900', type: 'recubrimientos' },
        ];

        // Object to store page content
        const paginas = {
            'inicio': `
                <div class="text-center py-20">
                    <h2 class="text-5xl font-extrabold text-gray-800 mb-4 animate-fade-in-down">¡Bienvenido a Mi Curso en Línea!</h2>
                    <p class="text-lg text-gray-600 mb-8 animate-fade-in">Aprende nuevas habilidades y alcanza tus metas profesionales.</p>
                    <a href="#" onclick="cargarCursosPorTipo('todos')" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300">
                        Explora nuestros cursos
                    </a>
                </div>
            `,
            'cursos': '', // This page is now loaded dynamically by cargarCursosPorTipo
            'aula-virtual': `
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full mx-auto animate-fade-in-down">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Mi Aula Virtual</h2>
                    <div id="enrolled-courses-list" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <p class="text-center text-gray-500 col-span-full">Cargando cursos...</p>
                    </div>
                </div>
            `,
            'certificados': `
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl mx-auto animate-fade-in-down">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Generar Certificado o Diploma</h2>
                    <div id="user-info-display" class="bg-gray-100 p-4 rounded-lg mb-6 text-center">
                        <span class="text-gray-600">ID de Usuario:</span> <span id="user-id-text" class="font-mono font-bold text-sm text-gray-800">Cargando...</span>
                    </div>
                    <form id="certificate-form" class="space-y-6" onsubmit="generarDocumento(event)">
                        <div>
                            <label for="student-name" class="block text-gray-700 font-medium mb-2">Nombre del Estudiante</label>
                            <input type="text" id="student-name" name="student-name" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej. Juan Pérez" required>
                        </div>
                        <div>
                            <label for="course-name" class="block text-gray-700 font-medium mb-2">Selecciona el Curso</label>
                            <select id="course-name" name="course-name" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">-- Elige un curso --</option>
                            </select>
                        </div>
                        <div>
                            <label for="final-grade" class="block text-gray-700 font-medium mb-2">Nota Final (0-100)</label>
                            <input type="number" id="final-grade" name="final-grade" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" max="100" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105">
                            Generar Documento
                        </button>
                    </form>
                    <div id="document-output" class="mt-8 rounded-lg overflow-hidden border border-gray-300">
                        <!-- The certificate or diploma will be displayed here -->
                    </div>
                </div>
            `,
            'contacto': `
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xl mx-auto animate-fade-in-up">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Contáctanos</h2>
                    <form id="contact-form" class="space-y-6">
                        <div>
                            <label for="contact-name" class="block text-gray-700 font-medium mb-2">Nombre Completo</label>
                            <input type="text" id="contact-name" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="contact-email" class="block text-gray-700 font-medium mb-2">Correo Electrónico</label>
                            <input type="email" id="contact-email" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="contact-message" class="block text-gray-700 font-medium mb-2">Tu Mensaje</label>
                            <textarea id="contact-message" rows="5" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105">
                            Enviar Mensaje
                        </button>
                    </form>
                </div>
            `,
            'login': `
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg mx-auto animate-fade-in-down">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Acceso a Aula</h2>
                    <div class="space-y-6">
                        <h3 class="text-2xl font-semibold text-gray-700">Iniciar Sesión</h3>
                        <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                            <div>
                                <label for="login-email" class="block text-gray-700 font-medium mb-2">ID de Usuario</label>
                                <input type="text" id="login-email" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Ej. user001@example.com">
                            </div>
                            <div>
                                <label for="login-password" class="block text-gray-700 font-medium mb-2">Clave de Acceso</label>
                                <input type="password" id="login-password" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-300">
                                Acceder
                            </button>
                        </form>
                    </div>
                </div>
            `
        };

        async function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // This listener ensures we have the user state before fetching data
                onAuthStateChanged(auth, async (user) => {
                    userAuthState.user = user;
                    userAuthState.loaded = true;
                    if (user) {
                        console.log("Firebase Auth State Changed: User is signed in:", user.uid);
                    } else {
                        console.log("Firebase Auth State Changed: User is signed out.");
                    }
                });

                // Authenticate the user with the provided custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                mostrarModal('Error de Inicialización', 'No se pudo conectar a la base de datos. Por favor, inténtalo de nuevo.');
            }
        }

        function mostrarModal(title, message) {
            const modal = document.getElementById('alert-modal');
            const modalTitle = document.getElementById('alert-title');
            const modalMessage = document.getElementById('alert-message');
            
            modalTitle.innerHTML = title;
            modalMessage.innerHTML = message;
            modal.classList.remove('hidden');
        }

        function cerrarPago() {
            document.getElementById('payment-modal').classList.add('hidden');
            tempCourseData = null; // Clear temp data on cancel
        }

        function generarDocumento(event) {
            event.preventDefault();

            const studentName = document.getElementById('student-name').value;
            const courseName = document.getElementById('course-name').value;
            const finalGrade = parseInt(document.getElementById('final-grade').value);
            const documentOutput = document.getElementById('document-output');

            if (finalGrade >= 70) {
                // Generate approval certificate
                documentOutput.innerHTML = `
                    <div class="certificate-container p-12 text-center text-gray-800">
                        <h3 class="text-4xl font-extrabold mb-8">CERTIFICADO DE APROBACIÓN</h3>
                        <p class="text-lg font-medium">Este documento certifica que</p>
                        <p class="text-5xl font-bold my-4">${studentName}</p>
                        <p class="text-lg font-medium">ha completado satisfactoriamente el curso de</p>
                        <p class="text-3xl font-bold my-4">${courseName}</p>
                        <p class="text-lg font-medium">con una nota final de</p>
                        <p class="text-3xl font-bold mt-4">${finalGrade}/100</p>
                        <p class="text-sm italic mt-8">Emitido el ${new Date().toLocaleDateString('es-ES')}</p>
                    </div>
                `;
            } else {
                // Generate participation diploma
                documentOutput.innerHTML = `
                    <div class="diploma-container p-12 text-center text-gray-800">
                        <h3 class="text-4xl font-extrabold mb-8">DIPLOMA DE PARTICIPACIÓN</h3>
                        <p class="text-lg font-medium">Este documento certifica que</p>
                        <p class="text-5xl font-bold my-4">${studentName}</p>
                        <p class="text-lg font-medium">ha participado en el curso de</p>
                        <p class="text-3xl font-bold my-4">${courseName}</p>
                        <p class="text-sm italic mt-8">Emitido el ${new Date().toLocaleDateString('es-ES')}</p>
                    </div>
                `;
            }
        }

        // Functions to dynamically load page content
        async function cargarPagina(nombrePagina) {
            const contenido = document.getElementById('contenido');
            contenido.innerHTML = paginas[nombrePagina];

            // Show user ID on certificates page
            if (nombrePagina === 'certificados') {
                while (!userAuthState.loaded) { await new Promise(resolve => setTimeout(resolve, 100)); }
                const userId = userAuthState.user?.uid || 'N/A';
                document.getElementById('user-id-text').textContent = userId;
                await populateCertificateCourseDropdown();
            }
        }
        
        async function cargarCursosPorTipo(tipo = 'todos') {
            await new Promise(resolve => onAuthStateChanged(auth, resolve));
            const userId = auth.currentUser?.uid;

            const contenido = document.getElementById('contenido');
            const cursosFiltrados = tipo === 'todos' ? cursosData : cursosData.filter(curso => curso.type === tipo);
            
            let cursosHTML = `<h2 class="text-4xl font-extrabold text-gray-800 mb-8 text-center animate-fade-in-up">Nuestros Cursos Disponibles</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">`;
            
            // Check enrolled courses from Firestore
            let enrolledCourses = [];
            if (userId) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private/data/profile`);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    enrolledCourses = userDocSnap.data().enrolledCourses || [];
                }
            }
            
            cursosFiltrados.forEach(curso => {
                const isEnrolled = enrolledCourses.includes(curso.id);
                const buttonText = isEnrolled ? 'Ya inscrito' : 'Registrarme';
                const buttonDisabled = isEnrolled ? 'disabled' : '';
                const buttonColor = isEnrolled ? 'bg-gray-400 cursor-not-allowed' : `bg-white ${curso.buttonColor} hover:bg-gray-100`;

                cursosHTML += `
                    <div class="${curso.color} p-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 text-white transition duration-300 animate-fade-in">
                        <i class="${curso.icon} text-4xl mb-4 opacity-75"></i>
                        <h3 class="text-2xl font-bold mb-2">${curso.title}</h3>
                        <p class="text-sm opacity-90 mb-4">${curso.description}</p>
                        <p class="text-sm font-medium mb-1">Duración: ${curso.duration}</p>
                        <p class="text-sm font-medium mb-4">Modalidad: ${curso.modality}</p>
                        
                        <button onclick="mostrarFormulario('form-${curso.id}')" class="${buttonColor} font-semibold py-2 px-6 rounded-full shadow-md transition-colors duration-300" ${buttonDisabled}>
                            ${buttonText}
                        </button>

                        <!-- Registration form (hidden by default) -->
                        <form id="form-${curso.id}" class="hidden mt-6 bg-white text-gray-900 p-6 rounded-xl shadow-md space-y-4" onsubmit="procesarRegistro(event, '${curso.id}')">
                            <h4 class="text-xl font-bold">Registro: ${curso.title}</h4>
                            <div>
                                <label class="block mb-1 font-medium text-sm">Nombre completo</label>
                                <input type="text" name="nombre" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 ${curso.ringColor}" required>
                            </div>
                            <div>
                                <label class="block mb-1 font-medium text-sm">Correo electrónico</label>
                                <input type="email" name="email" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 ${curso.ringColor}" required>
                            </div>
                            <input type="hidden" name="curso" value="${curso.title}">
                            <button type="submit" class="w-full ${curso.color} text-white font-semibold py-2 px-4 rounded-lg hover:${curso.color.replace('600', '700')} transition-colors duration-300">
                                Enviar registro y pagar
                            </button>
                        </form>
                    </div>
                `;
            });
            cursosHTML += `</div>`;
            contenido.innerHTML = cursosHTML;
        }

        function mostrarFormulario(formId) {
            document.querySelectorAll('form[id^="form-"]').forEach(form => {
                form.classList.add('hidden');
            });
            const formToShow = document.getElementById(formId);
            if (formToShow) {
                formToShow.classList.remove('hidden');
            }
        }
        
        function procesarRegistro(event, cursoId) {
            event.preventDefault();
            const form = event.target;
            tempCourseData = {
                id: cursoId,
                title: form.querySelector('input[name="curso"]').value,
                studentName: form.querySelector('input[name="nombre"]').value,
                email: form.querySelector('input[name="email"]').value
            };
            document.getElementById('payment-modal').classList.remove('hidden');
            document.getElementById('payment-course-title').textContent = `Pago: ${tempCourseData.title}`;
        }

        async function simularProcesoDePago() {
            // Get data from the payment form
            const cardNumber = document.getElementById('card-number').value;
            const cardExpiry = document.getElementById('card-expiry').value;
            const cardCvc = document.getElementById('card-cvc').value;

            // Simple validation for mock purposes
            if (!cardNumber || !cardExpiry || !cardCvc) {
                mostrarModal('Error', 'Por favor, completa todos los campos de pago.');
                return;
            }

            // Simulate a "real" payment API call to a backend
            // In a real app, this would be a secure fetch call to your server
            const paymentSuccessful = Math.random() > 0.1; // 90% chance of success

            if (paymentSuccessful) {
                mostrarModal('Procesando Pago', 'El pago se está procesando. Por favor, espera...');
                document.getElementById('payment-modal').classList.add('hidden');
                setTimeout(async () => {
                    await inscribirUsuarioEnCurso();
                }, 2000); // Simulate network delay
            } else {
                mostrarModal('Pago Fallido', 'La transacción fue rechazada. Por favor, verifica tus datos e inténtalo de nuevo.');
                cerrarPago();
            }
        }
        
        async function inscribirUsuarioEnCurso() {
            const { id, title, studentName, email } = tempCourseData;
            const userId = auth.currentUser?.uid;

            if (!userId) {
                mostrarModal('Error', 'Debes iniciar sesión para inscribirte en un curso.');
                return;
            }

            try {
                // Get the user's profile document
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private/data/profile`);
                const userDocSnap = await getDoc(userDocRef);

                let enrolledCourses = [];
                if (userDocSnap.exists()) {
                    enrolledCourses = userDocSnap.data().enrolledCourses || [];
                }
                
                // Add the new course if not already enrolled
                if (!enrolledCourses.includes(id)) {
                    enrolledCourses.push(id);
                }

                await setDoc(userDocRef, {
                    name: studentName,
                    email: email,
                    enrolledCourses: enrolledCourses,
                    completedCourses: userDocSnap.exists() ? userDocSnap.data().completedCourses || [] : [],
                }, { merge: true });

                mostrarModal('Inscripción Exitosa', `¡Te has inscrito en el curso "${title}"! Ahora puedes acceder al Aula Virtual.`);
                setTimeout(() => {
                    checkAndLoadVirtualClassroom();
                }, 2000);
            } catch (error) {
                console.error("Error al inscribir al usuario:", error);
                mostrarModal('Error de Inscripción', 'Ocurrió un error al inscribirte. Por favor, inténtalo de nuevo.');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                // This is a mock login, as Firebase Auth is handled by the environment
                // For a real app, you would use signInWithEmailAndPassword() here.
                // For now, we'll just check if the email is 'user001@example.com'
                if (email === 'user001@example.com' && password === 'password123') {
                    // Create a placeholder user document to mimic a login
                    const userDocRef = doc(db, `artifacts/${appId}/users/${auth.currentUser?.uid}/private/data/profile`);
                    await setDoc(userDocRef, {
                        name: 'Usuario Prueba',
                        email: 'user001@example.com',
                        enrolledCourses: ['java', 'automotrices'],
                        completedCourses: ['python', 'nanorecubrimientos'] // Simulating completed courses for certificate demo
                    }, { merge: true });
                    mostrarModal('Éxito', '¡Has iniciado sesión correctamente!');
                    checkAndLoadVirtualClassroom();
                } else {
                    mostrarModal('Error', 'ID de Usuario o clave de acceso incorrectos.');
                }
            } catch (error) {
                console.error("Error during login:", error);
                mostrarModal('Error', 'Hubo un problema al intentar iniciar sesión.');
            }
        }
        
        async function checkAuthState() {
            await new Promise(resolve => onAuthStateChanged(auth, resolve));
            const userId = auth.currentUser?.uid;
            if (userId) {
                cargarPagina('certificados');
            } else {
                cargarPagina('login');
            }
        }
        
        async function checkAndLoadVirtualClassroom() {
            await new Promise(resolve => onAuthStateChanged(auth, resolve));
            const userId = auth.currentUser?.uid;
            if (userId) {
                cargarPagina('aula-virtual');
                const listContainer = document.getElementById('enrolled-courses-list');
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private/data/profile`);
                
                // Real-time listener for enrolled courses
                onSnapshot(userDocRef, (docSnap) => {
                    listContainer.innerHTML = '';
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        const enrolledCourseIds = userData.enrolledCourses || [];
                        if (enrolledCourseIds.length > 0) {
                            enrolledCourseIds.forEach(courseId => {
                                const course = cursosData.find(c => c.id === courseId);
                                if (course) {
                                    listContainer.innerHTML += `
                                        <div class="bg-blue-100 p-6 rounded-xl shadow-lg flex items-center space-x-4 animate-fade-in-up">
                                            <div class="text-blue-600 text-3xl">
                                                <i class="${course.icon}"></i>
                                            </div>
                                            <div>
                                                <h4 class="text-xl font-bold text-blue-800">${course.title}</h4>
                                                <p class="text-gray-600 text-sm">${course.description}</p>
                                            </div>
                                        </div>
                                    `;
                                }
                            });
                        } else {
                            listContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">No estás inscrito en ningún curso. ¡Explora nuestros cursos para comenzar!</p>`;
                        }
                    } else {
                         listContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">No estás inscrito en ningún curso. ¡Explora nuestros cursos para comenzar!</p>`;
                    }
                });
            } else {
                cargarPagina('login');
            }
        }
        
        async function populateCertificateCourseDropdown() {
            const selectElement = document.getElementById('course-name');
            selectElement.innerHTML = '<option value="">-- Elige un curso --</option>';
            
            await new Promise(resolve => onAuthStateChanged(auth, resolve));
            const userId = auth.currentUser?.uid;
            
            if (userId) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private/data/profile`);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    const completedCourseIds = userDocSnap.data().completedCourses || [];
                    completedCourseIds.forEach(courseId => {
                        const course = cursosData.find(c => c.id === courseId);
                        if (course) {
                            const option = document.createElement('option');
                            option.value = course.title;
                            option.textContent = course.title;
                            selectElement.appendChild(option);
                        }
                    });
                }
            }
        }

        // Initialize Firebase on window load
        window.onload = async function() {
            await setupFirebase();
            cargarPagina('inicio');
        };
    </script>
</body>
</html>
